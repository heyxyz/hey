name: Deploy Docker Images

env:
  API_RAILWAY_SERVICE_ID: 4a2a1bfb-e499-4c71-bf7f-d9ad47443c31
  OG_RAILWAY_SERVICE_ID: 76d31e4b-218d-4f82-974d-f2c8e91480e2

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api:
    name: heyxyz:api
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸšª
        uses: actions/checkout@v4

      - name: Build and push heyxyz/api ðŸš€
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: api
          tag_name: 'latest'
          docker_file: ./apps/api/Dockerfile

      - name: Trigger API Deployment ðŸš€
        uses: indiesdev/curl@v1
        id: deploy
        with:
          url: 'https://redeploy.heyxyz.workers.dev'
          params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.API_RAILWAY_SERVICE_ID }}" }'
          method: 'GET'
          timeout: 30000

  og:
    name: heyxyz:og
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸšª
        uses: actions/checkout@v4

      - name: Build and push heyxyz/og ðŸš€
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: og
          tag_name: 'latest'
          docker_file: ./apps/og/Dockerfile

      - name: Trigger OG Deployment ðŸš€
        uses: indiesdev/curl@v1
        id: deploy
        with:
          url: 'https://redeploy.heyxyz.workers.dev'
          params: '{ "secret": "${{ secrets.SECRET }}", "service": "${{ env.OG_RAILWAY_SERVICE_ID }}" }'
          method: 'GET'
          timeout: 30000

  web:
    name: heyxyz:web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸšª
        uses: actions/checkout@v4

      - name: Build and push heyxyz/web:mainnet ðŸš€
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: web
          tag_name: 'mainnet'
          docker_file: ./apps/web/Dockerfile
          build_args: |
            NEXT_PUBLIC_LENS_NETWORK=mainnet
            NEXT_PUBLIC_THIRDWEB_TOKEN=${{ secrets.NEXT_PUBLIC_THIRDWEB_TOKEN }}
            NEXT_PUBLIC_DECENT_API_KEY=${{ secrets.NEXT_PUBLIC_DECENT_API_KEY }}
            NEXT_PUBLIC_OPENSEA_API_KEY=${{ secrets.NEXT_PUBLIC_OPENSEA_API_KEY }}
            NEXT_PUBLIC_RARIBLE_API_KEY=${{ secrets.NEXT_PUBLIC_RARIBLE_API_KEY }}

      - name: Build and push heyxyz/web:testnet ðŸš€
        uses: ./.github/actions/docker
        with:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          image_name: web
          tag_name: 'testnet'
          docker_file: ./apps/web/Dockerfile
          build_args: |
            NEXT_PUBLIC_LENS_NETWORK=testnet
            NEXT_PUBLIC_THIRDWEB_TOKEN=${{ secrets.NEXT_PUBLIC_THIRDWEB_TOKEN }}
            NEXT_PUBLIC_DECENT_API_KEY=${{ secrets.NEXT_PUBLIC_DECENT_API_KEY }}
            NEXT_PUBLIC_OPENSEA_API_KEY=${{ secrets.NEXT_PUBLIC_OPENSEA_API_KEY }}
            NEXT_PUBLIC_RARIBLE_API_KEY=${{ secrets.NEXT_PUBLIC_RARIBLE_API_KEY }}
